<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generator zdjęć z ramką — POZA SCHEMATEM</title>
  <meta name="description" content="Wgraj zdjęcie, dopasuj do ramki i pobierz gotowy obraz 4:5." />
  <style>
    :root{
      --bg:#ffffff;
      --text:#000000;
      --muted:#334155;
      --accent:#00c4cc; /* jasny turkus */
      --accent-weak:#b8f3f5;
      --card:#f8fafc;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    header{margin-bottom:14px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr}}

    /* Podgląd */
    .stage{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    canvas{max-width:100%;height:auto;display:block;margin:auto;border:1px solid var(--border);border-radius:10px;background:#fff}

    /* Prawy panel */
    .sidebar{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:16px}
    .sidebar h1{font-size:18px;margin:0 0 8px 0;color:var(--muted)}
    .lead{font-size:14px;line-height:1.45;color:#055c60;background:var(--accent-weak);border:1px solid #92e9ec;padding:10px;border-radius:10px}

    .group{margin-top:16px;padding:12px;border:1px dashed #aeecef;border-radius:10px;background:#ffffff}
    .group h3{margin:0 0 10px 0;font-size:14px;color:#066a6e}

    .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:#003436;font-weight:700;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.secondary{background:#e6ffff;color:#055c60}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}

    label{font-size:13px;color:#055c60}

    input[type="file"]{width:100%}

    /* Slider turkusowy */
    input[type="range"]{width:100%;accent-color:var(--accent)}
    .range-meta{display:flex;justify-content:space-between;font-size:12px;color:#066a6e;margin-top:4px}

    footer{margin-top:18px;text-align:center;font-size:13px;color:#475569}
    footer a{color:#0ea5a9;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="stage">
        <canvas id="canvas"></canvas>
      </div>

      <aside class="sidebar">
        <h1>Generator zdjęć z ramką</h1>
        <p class="lead">
          Pokaż innym, że uczestniczysz w konferencji
          „AUTYZM, ADHD POZA SCHEMATEM – zaburzenia neurorozwojowe w ujęciu interdyscyplinarnym”.
          Wgraj swoje zdjęcie, dopasuj do ramki, pobierz i wstaw na swoje media społecznościowe z hashtagiem
          <strong>#pozaschematem</strong>.
        </p>

        <div class="group">
          <h3>1) Wgraj zdjęcie</h3>
          <input id="file" type="file" accept="image/*" />
        </div>

        <div class="group">
          <h3>2) Powiększenie</h3>
          <input id="zoom" type="range" min="-1.0" max="2.0" step="0.001" value="0" />
          <div class="range-meta"><span>mniejsze</span><span>0 (dopasuj)</span><span>większe</span></div>
          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="rotate">Obróć 90°</button>
            <button class="btn secondary" id="reset">Wycentruj</button>
          </div>
        </div>

        <div class="group">
          <h3>3) Pobierz</h3>
          <div class="row">
            <button class="btn" id="downloadPng">Pobierz PNG</button>
            <button class="btn" id="downloadJpg">Pobierz JPG</button>
          </div>
        </div>

        <footer>
          © 2025 <a href="https://konferencjarozwinskrzydla.pl" target="_blank" rel="noopener">konferencjarozwinskrzydla.pl</a>
        </footer>
      </aside>
    </div>
  </div>

<script>
(() => {
  const FRAME_SRC = 'ramka.png'; // bez spacji/PL znaków dla GitHub Pages

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const fileInput = document.getElementById('file');
  const rotateBtn = document.getElementById('rotate');
  const resetBtn = document.getElementById('reset');
  const zoomSlider = document.getElementById('zoom');
  const downloadPngBtn = document.getElementById('downloadPng');
  const downloadJpgBtn = document.getElementById('downloadJpg');

  const state = {
    frame: new Image(),
    frameLoaded: false,
    img: new Image(),
    imgLoaded: false,
    angle: 0,
    scale: 1,       // faktyczny scale używany do rysowania
    fitScale: 1,    // skala „dopasuj do wypełnienia” (cover)
    x: 0,
    y: 0,
    isPanning: false,
    lastX: 0,
    lastY: 0
  };

  // Wczytaj ramkę i ustaw canvas dokładnie na jej rozmiar
  state.frame.onload = () => {
    state.frameLoaded = true;
    canvas.width = state.frame.width;
    canvas.height = state.frame.height;
    draw();
  };
  state.frame.src = encodeURI(FRAME_SRC);

  function rotatedDims(){
    const swap = (state.angle % 180 !== 0);
    return swap ? {w: state.img.height, h: state.img.width} : {w: state.img.width, h: state.img.height};
  }

  // oblicz skalę typu „cover” (wypełnij cały obszar ramki)
  function computeFitScale(){
    const {w: iw, h: ih} = rotatedDims();
    const cw = canvas.width, ch = canvas.height;
    return Math.max(cw/iw, ch/ih);
  }

  function recalcAfterImageOrRotate(){
    if(!state.imgLoaded) return;
    state.fitScale = computeFitScale();
    setScaleFromSlider(parseFloat(zoomSlider.value)); // odśwież scale względem fitScale
    centerImage();
    draw();
  }

  function centerImage(){
    state.x = 0; state.y = 0;
  }

  function clampPan(){
    const {w: iw, h: ih} = rotatedDims();
    const dw = iw * state.scale;
    const dh = ih * state.scale;
    const minX = Math.min(0, (canvas.width - dw)/2);
    const maxX = Math.max(0, (dw - canvas.width)/2);
    const minY = Math.min(0, (canvas.height - dh)/2);
    const maxY = Math.max(0, (dh - canvas.height)/2);
    state.x = Math.max(minX, Math.min(maxX, state.x));
    state.y = Math.max(minY, Math.min(maxY, state.y));
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(state.imgLoaded){
      ctx.save();
      ctx.translate(canvas.width/2 + state.x, canvas.height/2 + state.y);
      ctx.rotate(state.angle * Math.PI/180);
      const iw = state.img.width, ih = state.img.height;
      ctx.drawImage(state.img, -iw*state.scale/2, -ih*state.scale/2, iw*state.scale, ih*state.scale);
      ctx.restore();
    }
    if(state.frameLoaded){
      ctx.drawImage(state.frame, 0, 0);
    }
  }

  function loadImageFromFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    const tmp = new Image();
    tmp.onload = () => {
      state.img = tmp; state.imgLoaded = true; state.angle = 0;
      // ustaw suwak na 0 (fit) i przelicz skale
      zoomSlider.value = '0';
      recalcAfterImageOrRotate();
      URL.revokeObjectURL(url);
    };
    tmp.src = url;
  }

  function setScaleFromSlider(sv){
    // interpretujemy sv jako log2 multiplikatora względem fitScale
    // sv=0 => scale=fit; sv<0 => pomniejsz; sv>0 => powiększ
    const factor = Math.pow(2, sv);
    // pozwól nawet na mniejsze niż fit (np. 0.25x fit), ale nie schodź ekstremalnie nisko
    const minFactor = 0.25; // minimalnie 1/4 dopasowania
    const maxFactor = 8;    // maksymalnie 8x dopasowania
    const clamped = Math.max(minFactor, Math.min(maxFactor, factor));
    state.scale = state.fitScale * clamped;
    clampPan();
  }

  // === Zdarzenia ===
  fileInput.addEventListener('change', (e) => loadImageFromFile(e.target.files[0]));

  let pointerId = null;
  canvas.addEventListener('pointerdown', (e)=>{
    if(!state.imgLoaded) return;
    pointerId = e.pointerId; canvas.setPointerCapture(pointerId);
    state.isPanning = true; state.lastX = e.clientX; state.lastY = e.clientY;
  });
  canvas.addEventListener('pointermove',(e)=>{
    if(!state.isPanning || e.pointerId !== pointerId) return;
    state.x += e.clientX - state.lastX; state.y += e.clientY - state.lastY;
    state.lastX = e.clientX; state.lastY = e.clientY;
    clampPan(); draw();
  });
  const endPan = (e)=>{ if(e.pointerId!==pointerId) return; state.isPanning=false; canvas.releasePointerCapture(pointerId); pointerId=null; };
  canvas.addEventListener('pointerup', endPan);
  canvas.addEventListener('pointercancel', endPan);

  zoomSlider.addEventListener('input', ()=>{
    if(!state.imgLoaded) return;
    setScaleFromSlider(parseFloat(zoomSlider.value));
    draw();
  });

  rotateBtn.addEventListener('click', ()=>{
    if(!state.imgLoaded) return;
    state.angle = (state.angle + 90) % 360;
    recalcAfterImageOrRotate();
  });
  resetBtn.addEventListener('click', ()=>{
    if(!state.imgLoaded) return;
    zoomSlider.value = '0';
    recalcAfterImageOrRotate();
  });

  function download(mime='image/png', quality){
    const out = document.createElement('canvas');
    out.width = canvas.width; out.height = canvas.height;
    const octx = out.getContext('2d');

    if(state.imgLoaded){
      octx.save();
      octx.translate(out.width/2 + state.x, out.height/2 + state.y);
      octx.rotate(state.angle * Math.PI/180);
      const iw = state.img.width, ih = state.img.height;
      octx.drawImage(state.img, -iw*state.scale/2, -ih*state.scale/2, iw*state.scale, ih*state.scale);
      octx.restore();
    }
    if(state.frameLoaded){ octx.drawImage(state.frame, 0, 0); }

    const url = out.toDataURL(mime, quality);
    const a = document.createElement('a'); a.href = url; a.download = (mime==='image/png'?'pozaschematem.png':'pozaschematem.jpg'); a.click();
  }
  downloadPngBtn.addEventListener('click', ()=> download('image/png'));
  downloadJpgBtn.addEventListener('click', ()=> download('image/jpeg', 0.92));
})();
</script>
</body>
</html>
